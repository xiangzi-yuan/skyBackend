# 缓存策略重构（版本号 key）代码改动清单

目标：把“用户端上架列表缓存”改为 **版本号 key**（`{bizKey}:v{ver}`），写操作只 **bump 版本号** 切换新 key；新增“详情缓存”独立 `cacheName`，写操作 **afterCommit 精准 evict**；并通过 Delegate Bean 规避 `@Cacheable` 的 self-invocation 失效问题。

> 本文只覆盖本次改动点，精确到「类 / 方法 / 关键代码」级别，便于 code review 与验收。

---

## 1. Redis Key 约定（本次使用分类粒度）

### 1.1 列表版本号 key（Redis String）

- 套餐列表版本号：`setmeal:list:ver:{categoryId}`
- 菜品列表版本号：`dish:list:ver:{categoryId}`

版本号值为数字字符串（初始化为 `"1"`），写操作使用 `INCR` 自增。

### 1.2 Spring Cache 中的实际缓存 key（Redis Key）

Spring Cache（RedisCacheManager）默认会生成形如 `cacheName::cacheKey` 的 Redis key，例如：

- 套餐上架列表：`setmealCache::{categoryId}:v{ver}`
- 菜品上架列表：`dishCache::{categoryId}:v{ver}`
- 套餐详情：`setmealDetailCache::{id}`
- 菜品详情：`dishDetailCache::{id}`

---

## 2. CacheName 与 TTL（RedisCacheManager）

文件：`sky-server/src/main/java/com/sky/config/CacheConfiguration.java`

- `setmealCache`：10 分钟（列表）
- `dishCache`：10 分钟（列表）
- `categoryCache`：30 分钟（未改动，分类变化少）
- `setmealDetailCache`：60 分钟（详情）
- `dishDetailCache`：60 分钟（详情）

关键新增配置：

```java
cacheConfigurations.put("setmealDetailCache", defaultConfig.entryTtl(Duration.ofMinutes(60)));
cacheConfigurations.put("dishDetailCache", defaultConfig.entryTtl(Duration.ofMinutes(60)));
```

---

## 3. 新增：版本号管理组件

### 3.1 `VersionService`

文件：`sky-server/src/main/java/com/sky/service/VersionService.java`

新增 3 个方法：

- `long getOrInit(String verKey)`
- `void bump(String verKey)`
- `void bumpAfterCommit(String verKey)`

### 3.2 `VersionServiceImpl`

文件：`sky-server/src/main/java/com/sky/service/impl/VersionServiceImpl.java`

实现要点（代码行为级）：

- `getOrInit(verKey)`：
  - 先 `GET`；不存在则 `SETNX "1"`；若 `SETNX` 失败再 `GET` 兜底
  - Redis 异常：`warn` 日志 + **降级返回 1**
- `bump(verKey)`：
  - `INCR`；异常只 `warn`，**不抛出**
- `bumpAfterCommit(verKey)`：
  - 若事务同步激活：注册 `TransactionSynchronization.afterCommit()` -> `bump(verKey)`
  - 否则：直接 `bump(verKey)` 兜底

---

## 4. 新增：Cache Delegate（解决 self-invocation）

> 约束：**列表缓存的 `@Cacheable` 只允许写在 Delegate 上**；Service 层不再写 `@Cacheable`。

### 4.1 `SetmealCacheDelegate`

文件：`sky-server/src/main/java/com/sky/service/cache/SetmealCacheDelegate.java`

#### 4.1.1 用户端上架列表缓存

```java
@Cacheable(cacheNames = "setmealCache", key = "#categoryId + ':v' + #ver")
public List<SetmealListVO> listOnSaleByCategoryIdCached(Long categoryId, long ver)
```

内部查询与转换：

- `setmealMapper.listByCategoryId(categoryId, StatusConstant.ENABLE)`
- `setmealReadConvert.toListVOList(...)`

#### 4.1.2 套餐详情缓存

```java
@Cacheable(cacheNames = "setmealDetailCache", key = "#id")
public SetmealDetailVO getDetailByIdCached(Long id)
```

内部查询与组装：

- 主表：`setmealMapper.getDetailById(id)`，不存在直接返回 `null`
- 子表：`setmealDishMapper.selectBySetmealId(id)` + `setmealReadConvert.toDishVOList(...)`

### 4.2 `DishCacheDelegate`

文件：`sky-server/src/main/java/com/sky/service/cache/DishCacheDelegate.java`

#### 4.2.1 用户端上架列表缓存

```java
@Cacheable(cacheNames = "dishCache", key = "#categoryId + ':v' + #ver")
public List<DishDetailVO> listOnSaleByCategoryIdCached(Long categoryId, long ver)
```

内部查询与转换：

- `dishMapper.getByCategoryId(categoryId, StatusConstant.ENABLE, CategoryConstant.DISH)`
- `dishReadConvert.toDetailVO(...)`

#### 4.2.2 菜品详情缓存

```java
@Cacheable(cacheNames = "dishDetailCache", key = "#id")
public DishDetailVO getDetailByIdCached(Long id)
```

内部查询与组装：

- 主表：`dishMapper.getDetailById(id)`，不存在返回 `null`
- 口味：`dishFlavorMapper.selectByDishId(id)` + `dishReadConvert.toFlavorVOList(...)`

---

## 5. Service 层改造（只负责：取版本号 + afterCommit bump/evict）

### 5.1 `SetmealServiceImpl`

文件：`sky-server/src/main/java/com/sky/service/impl/SetmealServiceImpl.java`

#### 5.1.1 新增依赖与常量

- 注入：
  - `VersionService versionService`
  - `SetmealCacheDelegate setmealCacheDelegate`
  - `CacheManager cacheManager`（用于手动 evict）
- 常量：
  - `SETMEAL_LIST_VER_KEY_PREFIX = "setmeal:list:ver:"`
  - `SETMEAL_DETAIL_CACHE_NAME = "setmealDetailCache"`

#### 5.1.2 用户端列表（版本号 key）

方法：`listOnSaleByCategoryId(Long categoryId)`

- 取版本号：`versionService.getOrInit(SETMEAL_LIST_VER_KEY_PREFIX + categoryId)`
- 调用 Delegate 缓存方法：`setmealCacheDelegate.listOnSaleByCategoryIdCached(categoryId, ver)`

#### 5.1.3 详情查询统一走 Delegate 缓存

方法：`getDetailById(Long id)`

- `setmealCacheDelegate.getDetailByIdCached(id)`
- 返回 `null` 则抛异常：`MessageConstant.SETMEAL_NOT_FOUND`

#### 5.1.4 写操作统一 afterCommit：bump 列表版本号 + evict 详情

本次写方法均在提交后执行（回滚不会触发）：

- `save(SetmealCreateDTO dto)`
  - `bumpSetmealListVerAfterCommit(setmeal.getCategoryId())`
  - `evictAfterCommit("setmealDetailCache", setmealId)`
- `changeSetmeal(SetmealUpdateDTO dto)`
  - 变更前读取旧分类：`SetmealDetailRM existing = setmealMapper.getDetailById(setmealId)`
  - bump 旧分类；若 `dto.getCategoryId()` 变更且不同，再 bump 新分类
  - `evictAfterCommit("setmealDetailCache", setmealId)`
  - 移除“子表为空直接 return”的早退，避免 bump/evict 漏执行
- `delete(List<Long> ids)`（批量）
  - 删除前查询涉及分类：`setmealMapper.getCategoryIdsByIds(idList)`
  - afterCommit：对所有 `categoryId` 去重 bump
  - afterCommit：对所有 `setmealId` 逐个 evict 详情缓存
- `updateStatus(Long id, Integer status)`
  - **新增 `@Transactional`**（保证 afterCommit 生效）
  - 更新前读取分类：`setmealMapper.getDetailById(id)` -> `categoryId`
  - afterCommit：bump + evict

#### 5.1.5 本类新增工具方法

- `bumpSetmealListVerAfterCommit(Long categoryId)`
- `evictAfterCommit(String cacheName, Object key)`
- `evict(String cacheName, Object key)`

实现方式：`TransactionSynchronizationManager.registerSynchronization(... afterCommit ...)`；evict 异常吞掉（缓存故障不影响主业务）。

### 5.2 `DishServiceImpl`

文件：`sky-server/src/main/java/com/sky/service/impl/DishServiceImpl.java`

#### 5.2.1 新增依赖与常量

- 注入：
  - `VersionService versionService`
  - `DishCacheDelegate dishCacheDelegate`
  - `CacheManager cacheManager`
- 常量：
  - `DISH_LIST_VER_KEY_PREFIX = "dish:list:ver:"`
  - `DISH_DETAIL_CACHE_NAME = "dishDetailCache"`

#### 5.2.2 用户端列表（版本号 key）

方法：`listOnSaleByCategoryId(Long categoryId)`

- `ver = versionService.getOrInit(DISH_LIST_VER_KEY_PREFIX + categoryId)`
- `dishCacheDelegate.listOnSaleByCategoryIdCached(categoryId, ver)`

#### 5.2.3 详情查询统一走 Delegate 缓存

方法：`getDetailById(Long id)`

- `dishCacheDelegate.getDetailByIdCached(id)`
- 返回 `null` 则抛异常：`MessageConstant.DISH_NOT_FOUND_OR_UPDATE_FAILED`（项目中未提供单独 `DISH_NOT_FOUND` 常量）

#### 5.2.4 写操作统一 afterCommit：bump 列表版本号 + evict 详情

- `save(DishCreateDTO dto)`
  - `bumpDishListVerAfterCommit(dish.getCategoryId())`
  - `evictAfterCommit("dishDetailCache", dishId)`
- `changeDish(DishUpdateDTO dto)`
  - 变更前读取旧分类：`DishDetailRM existing = dishMapper.getDetailById(dishId)`
  - bump 旧分类；若 `dto.getCategoryId()` 变更且不同，再 bump 新分类
  - `evictAfterCommit("dishDetailCache", dishId)`
  - 移除“子表为空直接 return”的早退，避免 bump/evict 漏执行
- `delete(List<Long> ids)`（批量）
  - 删除前查询涉及分类：`dishMapper.getCategoryIdsByIds(idList)`
  - afterCommit：对所有 `categoryId` 去重 bump
  - afterCommit：对所有 `dishId` 逐个 evict 详情缓存
- `updateStatus(Long id, Integer status)`
  - **新增 `@Transactional`**
  - 更新前读取分类：`dishMapper.getDetailById(id)` -> `categoryId`
  - afterCommit：bump + evict

#### 5.2.5 本类新增工具方法

- `bumpDishListVerAfterCommit(Long categoryId)`
- `evictAfterCommit(String cacheName, Object key)`
- `evict(String cacheName, Object key)`

---

## 6. Mapper 改造：批量查分类 ID（用于批量 bump）

### 6.1 `SetmealMapper#getCategoryIdsByIds`

- 接口：`sky-server/src/main/java/com/sky/mapper/SetmealMapper.java`
- XML：`sky-server/src/main/resources/mapper/SetmealMapper.xml`

SQL（核心语义）：

```sql
select distinct category_id
from setmeal
where is_deleted = 0
  and id in (...)
```

### 6.2 `DishMapper#getCategoryIdsByIds`

- 接口：`sky-server/src/main/java/com/sky/mapper/DishMapper.java`
- XML：`sky-server/src/main/resources/mapper/DishMapper.xml`

SQL（核心语义）：

```sql
select distinct category_id
from dish
where is_deleted = 0
  and id in (...)
```

---

## 7. 全局约束检查（避免策略冲突）

- `@Cacheable` 仅出现在：
  - `SetmealCacheDelegate`
  - `DishCacheDelegate`
- 项目中无 `@CacheEvict(allEntries=true)` 相关残留（本次未引入）
- 后台列表接口（如 `listAllByCategoryId`）未做缓存；仅用户端“上架列表”走版本号 key 缓存

---

## 8. 构建验证

在本地执行通过：

```bash
mvn -DskipTests package
```

（如需按验收标准验证 Redis key 与回滚行为，可按任务书的 6.x 步骤操作。）  

