# Sky Backend 部署文档（Docker Compose + BuildKit/Buildx 缓存）

## 0. 目标

- 代码 push 到 GitHub `master` 后，GitHub Actions 自动：
  1. 将源码同步到服务器 `/opt/sky/skyBackend`
  2. 在服务器 `/opt/sky` 下执行 `docker compose build` + `up -d`
- 使用 BuildKit 缓存 + Maven 本地仓库缓存（`/root/.m2` cache mount）减少重复下载依赖。

------

## 1. 服务器目录与关键约束

### 1.1 目录约定

- **Compose 文件必须在：** `/opt/sky/docker-compose.yml`
- **项目源码在：** `/opt/sky/skyBackend`（由 scp 上传）
- **后端服务名固定为：** `backend`
- **后端容器名固定为：** `sky-backend`（在 compose 里写死时）

> 你 workflow 里 `cd /opt/sky && docker compose ...`，所以 compose 文件必须在 `/opt/sky`。

### 1.2 权限与用户

- 运行部署的用户需要在 `docker` 组里：

  ```
  id
  groups
  ```

  输出里有 `docker` 即可。

------

## 2. 构建缓存策略（BuildKit + buildx）

### 2.1 为什么要单独 buildx builder

- 默认 builder（`driver=docker`）的缓存容易被 GC 回收/不可控，导致“隔天又开始 Downloading”
- 使用 `driver=docker-container` 创建一个独立 BuildKit 容器，缓存更稳定

### 2.2 在服务器上创建 builder（一次性）

（下面是 **10GB** 版本，字节数写法必须这样写）

```
docker buildx rm skybuilder 2>/dev/null || true
docker rm -f buildx_buildkit_skybuilder0 2>/dev/null || true

docker buildx create --name skybuilder --driver docker-container --use \
  --buildkitd-flags '--oci-worker-gc-keepstorage=10737418240'

docker buildx inspect --bootstrap
docker buildx ls
```

### 2.3 查看缓存占用（不要盯 488MiB 那种显示）

```
docker buildx du --verbose | head -n 200
```

------

## 3. 日常维护命令（重点：后端日志）

> 下面命令默认你在服务器上。

### 3.1 查看服务状态

```
cd /opt/sky
docker compose ps
```

### 3.2 查看后端日志（最常用）

**实时跟踪：**

```
cd /opt/sky
docker compose logs -f backend
```

**只看最近 200 行：**

```
cd /opt/sky
docker compose logs --tail=200 backend
```

**看最近 1 小时：**

```
cd /opt/sky
docker compose logs --since=1h backend
```

**如果你想绕过 compose，直接看容器日志：**

```
docker logs -f --tail=200 sky-backend
```

### 3.3 重启后端

```
cd /opt/sky
docker compose restart backend
```

### 3.4 重新构建并重启（强制用最新代码）

```
cd /opt/sky
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
docker buildx use skybuilder

docker compose build --pull=false backend
docker compose up -d backend
docker compose ps
```

### 3.5 健康检查/排障（后端 unhealthy）

```
cd /opt/sky
docker compose ps
docker compose logs --tail=200 backend
```

如果容器有 healthcheck，可进一步：

```java
docker inspect --format='{{json .State.Health}}' sky-backend | head
```