package com.sky.interceptor;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.sky.constant.JwtClaimsConstant;
import com.sky.constant.MessageConstant;
import com.sky.constant.StatusConstant;
import com.sky.context.BaseContext;
import com.sky.mapper.EmployeeMapper;
import com.sky.properties.JwtProperties;
import com.sky.readmodel.employee.EmployeeAuthInfo;
import com.sky.result.Result;
import com.sky.role.RoleLevel;
import com.sky.utils.JwtUtil;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
@Slf4j
public class JwtTokenAdminInterceptor implements HandlerInterceptor {

    @Autowired
    private JwtProperties jwtProperties;

    @Autowired
    private EmployeeMapper employeeMapper;

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        // 闈?Controller 鏂规硶锛堥潤鎬佽祫婧愮瓑锛夌洿鎺ユ斁琛?
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }

        // 1) 浠庤姹傚ご鍙?token锛坔eader 鍚嶇敱閰嶇疆 sky.jwt.adminTokenName 鍐冲畾锛?
        String token = request.getHeader(jwtProperties.getAdminTokenName());
        if (token == null || token.isBlank()) {
            writeJson401(response, MessageConstant.NOT_LOGIN);
            return false;
        }

        try {
            // 2) 瑙ｆ瀽 JWT
            Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);

            Long empId = Long.valueOf(String.valueOf(claims.get(JwtClaimsConstant.EMP_ID)));
            RoleLevel role = RoleLevel.from(claims.get(JwtClaimsConstant.EMP_ROLE));

            // 鍐欏叆涓婁笅鏂?
            BaseContext.setCurrentId(empId);
            BaseContext.setCurrentRole(role);

            String uri = request.getRequestURI();
            String method = request.getMethod();

            log.info("jwt鏍￠獙閫氳繃锛歟mpId={}, role={}, uri={}, method={}", empId, role, uri, method);

            // 3) 宸茬櫥褰曠櫧鍚嶅崟锛堟湭鏀瑰瘑涔熷厑璁革級锛氱櫥鍑?/ 鏀瑰瘑
            //    login 涓嶈蛋杩欓噷锛堝簲鍦?WebMvcConfiguration.excludePathPatterns 鏀捐锛?
            if (isLoginOnlyWhitelist(uri, method)) {
                return true;
            }

            // 4) 鍩轰簬鏁版嵁搴撴渶鏂扮姸鎬佸仛閴存潈淇℃伅鏍￠獙锛氱鐢?/ 鏄惁鏀瑰瘑
            //    鐩殑锛氳В鍐斥€滅鐢ㄨ处鍙蜂粛鑳藉甫鏃?token 璁块棶鈥濈殑闂
            EmployeeAuthInfo auth = employeeMapper.getAuthInfoById(empId);
            if (auth == null) {
                writeJson401(response, MessageConstant.ACCOUNT_NOT_FOUND);
                return false;
            }

            // 4.1) 绂佺敤璐﹀彿锛氱洿鎺ユ嫆缁?
            if (auth.getStatus() != null && auth.getStatus() == StatusConstant.DISABLE) {
                writeJson403(response, MessageConstant.ACCOUNT_LOCKED);
                return false;
            }

            // 4.2) 寮哄埗鏀瑰瘑锛氭湭鏀瑰瘑 -> 403锛堢櫧鍚嶅崟闄ゅ锛?
            if (auth.getPwdChanged() == null || auth.getPwdChanged() == 0) {
                writeJson403(response, MessageConstant.PASSWORD_NEED_CHANGE);
                return false;
            }

            // 5) RBAC锛氫笁绾ф潈闄?
            String permissionError = checkPermission(role, uri, method);
            if (permissionError != null) {
                writeJson403(response, permissionError);
                return false;
            }

            return true;

        } catch (Exception ex) {
            log.warn("jwt鏍￠獙澶辫触锛歿}", ex.getMessage());
            writeJson401(response, MessageConstant.NOT_LOGIN);
            return false;
        }
    }

    /**
     * 鐧藉悕鍗曪細鍙宸茬櫥褰曞嵆鍙闂紙骞朵笖鍏佽鏈敼瀵嗚闂級
     */
    private boolean isLoginOnlyWhitelist(String uri, String method) {
        return ("/admin/employee/logout".equals(uri) && "POST".equalsIgnoreCase(method))
                || ("/admin/employee/editPassword".equals(uri) && "PUT".equalsIgnoreCase(method));
    }

    /**
     * 涓夌骇鏉冮檺鏍￠獙
     * @return null 琛ㄧず鏈夋潈闄愶紱闈?null 杩斿洖鍏蜂綋閿欒淇℃伅
     */
    private String checkPermission(RoleLevel role, String uri, String method) {

        // SUPER锛氬叏鏀捐
        if (role == RoleLevel.SUPER) {
            return null;
        }

        // MANAGER锛氬厑璁稿憳宸ョ鐞嗏€滃彧璇烩€?GET)锛岀姝㈠啓
        if (role == RoleLevel.MANAGER) {

            // 鍛樺伐绠＄悊妯″潡锛氬彧鍏佽 GET锛堝垎椤点€佹寜id鏌ヨ锛夛紝鍏朵綑鎷掔粷
            if (uri.startsWith("/admin/employee")) {
                if ("GET".equalsIgnoreCase(method)) {
                    return null;
                }
                return MessageConstant.NO_PERMISSION_EMPLOYEE_WRITE;
            }

            // 鍏跺畠妯″潡鍏堝叏鏀捐锛堜綘鍚庨潰鍐嶇粏鍒嗭級
            return null;
        }

        // STAFF锛氬彧鍏佽鑷敤 + 浣庨闄╁彧璇?
        if (role == RoleLevel.STAFF) {
            // 鍒嗙被涓嬫媺
            if ("/admin/category/list".equals(uri) && "GET".equalsIgnoreCase(method)) return null;

            // 鑿滃搧/濂楅鍙
            if (uri.startsWith("/admin/dish") && "GET".equalsIgnoreCase(method)) return null;
            if (uri.startsWith("/admin/setmeal") && "GET".equalsIgnoreCase(method)) return null;

            // 璁㈠崟鍙
            if (uri.startsWith("/admin/order") && "GET".equalsIgnoreCase(method)) return null;

            // 鍏跺畠涓€寰嬫嫆缁?
            return "GET".equalsIgnoreCase(method) ? MessageConstant.NO_PERMISSION_STAFF_READ : MessageConstant.NO_PERMISSION_STAFF_WRITE;
        }

        // 鍏滃簳锛氭湭鐭ヨ鑹查粯璁ゆ嫆缁?
        return MessageConstant.NO_PERMISSION_UNKNOWN_ROLE;
    }

    private void writeJson401(HttpServletResponse response, String msg) throws Exception {
        response.setStatus(401);
        response.setContentType("application/json;charset=UTF-8");
        Result<Object> r = Result.error(msg);
        response.getWriter().write(objectMapper.writeValueAsString(r));
        response.getWriter().flush();
    }

    private void writeJson403(HttpServletResponse response, String msg) throws Exception {
        response.setStatus(403);
        response.setContentType("application/json;charset=UTF-8");
        Result<Object> r = Result.error(msg);
        response.getWriter().write(objectMapper.writeValueAsString(r));
        response.getWriter().flush();
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        BaseContext.removeCurrentId();
        BaseContext.removeCurrentRole();
    }
}

