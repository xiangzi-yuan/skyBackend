name: Deploy Backend

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 可选：出问题时一眼看出工作目录里到底有什么
      - name: Debug - list workspace
        run: |
          pwd
          ls -la
          find . -maxdepth 3 -type f | head -n 200

      - name: Upload source to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          overwrite: true
          target: /opt/sky/skyBackend
          source: |
            pom.xml
            mvn-settings.xml
            Dockerfile
            .dockerignore
            .mvn
            mvnw
            mvnw.cmd
            sky-common
            sky-pojo
            sky-server

      - name: Build & Restart backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            mkdir -p /opt/sky /opt/sky/skyBackend

            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # 幂等：没有 skybuilder 才创建；keepstorage=10GB(字节)
            if ! docker buildx inspect skybuilder >/dev/null 2>&1; then
              docker buildx create --name skybuilder --driver docker-container --use \
                --buildkitd-flags '--oci-worker-gc-keepstorage=10737418240'
            fi
            docker buildx use skybuilder
            docker buildx inspect --bootstrap >/dev/null

            cd /opt/sky

            # 基础镜像预拉，避免网络抖动
            docker pull maven:3.9.6-eclipse-temurin-17 || true
            docker pull eclipse-temurin:17-jre || true

            docker compose build --pull=false backend
            docker compose up -d backend
            docker compose ps

            echo "✅ 后端部署完成"
