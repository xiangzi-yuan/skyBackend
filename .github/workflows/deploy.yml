name: Deploy Backend

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 0) 先检查 secrets 是否存在（避免空跑）
      - name: Check SSH secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "SERVER_HOST is empty"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "SERVER_USER is empty"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "SSH_PRIVATE_KEY is empty"
            exit 1
          fi

      # 1) 上传源码到服务器 /opt/sky/skyBackend
      - name: Upload source to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          overwrite: true
          target: /opt/sky/skyBackend
          source: |
            pom.xml
            sky-common/**
            sky-pojo/**
            sky-server/**
            backend/Dockerfile

      # 2) 服务器上 build + up
      - name: Build & Restart backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -euo pipefail

            mkdir -p /opt/sky/skyBackend

            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # 你服务器上现在是 10GB（10737418240），这里必须一致
            if ! docker buildx inspect skybuilder >/dev/null 2>&1; then
              docker buildx create --name skybuilder --driver docker-container --use \
                --buildkitd-flags '--oci-worker-gc-keepstorage=10737418240'
            fi
            docker buildx use skybuilder
            docker buildx inspect --bootstrap >/dev/null

            cd /opt/sky

            docker pull maven:3.9.6-eclipse-temurin-17 || true
            docker pull eclipse-temurin:17-jre || true

            docker compose build --pull=false backend
            docker compose up -d backend
            docker compose ps

            # 如果 unhealthy，打印日志并失败
            if docker compose ps --format json | grep -q '"Service":"backend".*"Health":"unhealthy"'; then
              echo "backend unhealthy, tail logs:"
              docker compose logs -n 200 backend || true
              exit 1
            fi

            echo "✅ 后端部署完成"
